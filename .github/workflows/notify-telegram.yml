name: Notify Telegram on Release

on:
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram notification
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_BODY: ${{ github.event.release.body }}
          RELEASE_URL: ${{ github.event.release.html_url }}
        run: |
          MESSAGE="<b>ðŸš€ LaserSell SDK ${RELEASE_TAG}</b>"

          if [ -n "${RELEASE_NAME}" ] && [ "${RELEASE_NAME}" != "${RELEASE_TAG}" ]; then
            MESSAGE="${MESSAGE} â€” ${RELEASE_NAME}"
          fi

          if [ -n "${RELEASE_BODY}" ]; then
            # Strip markdown syntax, then escape HTML entities
            CLEAN_BODY=$(echo "${RELEASE_BODY}" | sed \
              -e 's/^###* *//' \
              -e 's/\*\*\([^*]*\)\*\*/\1/g' \
              -e 's/\*\([^*]*\)\*/\1/g' \
              -e 's/\[\([^]]*\)\]([^)]*)/\1/g' \
              -e 's/ *($//' \
              -e 's/^- /â€¢ /g' \
              -e 's/&/\&amp;/g' \
              -e 's/</\&lt;/g' \
              -e 's/>/\&gt;/g')
            MESSAGE="${MESSAGE}

          ${CLEAN_BODY}"
          fi

          MESSAGE="${MESSAGE}

          <a href=\"${RELEASE_URL}\">View release on GitHub</a>"

          curl -sf -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="HTML" \
            --data-urlencode "text=${MESSAGE}"
